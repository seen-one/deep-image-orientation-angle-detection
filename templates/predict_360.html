<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>360 Orientation Analysis</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style4.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style5.css') }}">
    <style>
        body {
            background: #f8f9fa;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            margin: 0;
        }

        #submitBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(209, 63, 68, 0.4);
        }

        .face-container {
            border: 2px solid #eee;
            background: #000;
        }

        .face-img {
            display: block;
            width: 100%;
        }

        .custom-switch .custom-control-label::before {
            background-color: #ddd;
        }

        .custom-switch .custom-control-input:checked~.custom-control-label::before {
            background-color: #d13f44;
            border-color: #d13f44;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-11">
                <div class="card shadow-lg border-0" style="border-radius: 15px; background: #fff;">
                    <div class="card-body p-4 p-md-5">
                        <h2 class="text-center mb-4" style="color: #d13f44; font-weight: 700;">360° Photo Orientation
                            Correction</h2>

                        <div id="setup-section">
                            <p class="text-muted text-center mb-5">Upload an equirectangular image or paste a URL to
                                calculate the required Pitch and Roll for horizon correction.</p>

                            <form id="uploadForm">
                                <div class="form-group mb-4">
                                    <label for="file" class="form-label" style="font-weight: 600;">Select 360°
                                        Image</label>
                                    <input type="file" class="form-control-file" id="file" name="file" accept="image/*">
                                </div>

                                <div class="text-center my-3">
                                    <span class="badge badge-secondary px-3 py-2" style="border-radius: 20px;">OR</span>
                                </div>

                                <div class="form-group mb-4">
                                    <label for="url" class="form-label" style="font-weight: 600;">Paste Image
                                        URL</label>
                                    <div class="input-group">
                                        <input type="url" class="form-control" id="url" name="url"
                                            placeholder="https://example.com/image.jpg">
                                        <div class="input-group-append">
                                            <button type="button" id="randomBtn" class="btn btn-outline-danger"
                                                title="Pick Random Panoramax Image">
                                                <i class="fas fa-dice"></i> Random
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-4">
                                        <div class="form-group mb-4">
                                            <label for="fov_pass1" class="form-label" style="font-weight: 600;">Pass 1
                                                FOV</label>
                                            <input type="number" class="form-control" id="fov_pass1" name="fov_pass1"
                                                value="120" step="1" min="10" max="180">
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="form-group mb-4">
                                            <label for="fov_pass2_fb" class="form-label" style="font-weight: 600;">Pass
                                                2 FOV (FB)</label>
                                            <input type="number" class="form-control" id="fov_pass2_fb"
                                                name="fov_pass2_fb" value="60" step="1" min="10" max="180">
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="form-group mb-4">
                                            <label for="fov_pass2_lr" class="form-label" style="font-weight: 600;">Pass
                                                2 FOV (LR)</label>
                                            <input type="number" class="form-control" id="fov_pass2_lr"
                                                name="fov_pass2_lr" value="60" step="1" min="10" max="180">
                                        </div>
                                    </div>
                                </div>

                                <input type="hidden" id="model" name="model" value="ViT">

                                <button type="submit" id="submitBtn" class="btn btn-block py-3 mt-4"
                                    style="background: linear-gradient(to right, #d13f44, #f2b411); color: white; border-radius: 30px; font-weight: 700; font-size: 1.1rem; border: none; transition: transform 0.2s;">
                                    Analyze & Preview In New Tab
                                </button>
                            </form>

                            <div id="loading" class="text-center mt-5" style="display: none;">
                                <div class="spinner-border text-danger" role="status">
                                    <span class="sr-only">Processing...</span>
                                </div>
                                <p class="mt-2 text-muted">Analyzing 360 faces... This may take a few seconds.</p>
                            </div>
                        </div>

                        <div id="results" class="mt-4" style="display: none;">
                            <div class="row">
                                <div class="col-lg-12 text-center mb-4">
                                    <div class="alert alert-success d-inline-block px-5" style="border-radius: 30px;">
                                        <i class="fas fa-check-circle mr-2"></i> Analysis Complete! A preview tab should
                                        have opened.
                                    </div>
                                </div>

                                <!-- Overall Correction -->
                                <div class="col-lg-5">
                                    <h4 class="mb-4" style="font-weight: 600;">Correction Parameters</h4>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="p-3 bg-light rounded shadow-sm mb-3 text-center">
                                                <h5 class="text-muted mb-1 small">ROLL OFFSET</h5>
                                                <h3 id="rollVal" style="color: #d13f44; font-weight: 800;">0.00°</h3>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="p-3 bg-light rounded shadow-sm mb-4 text-center">
                                                <h5 class="text-muted mb-1 small">PITCH OFFSET</h5>
                                                <h3 id="pitchVal" style="color: #f2b411; font-weight: 800;">0.00°</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-2 text-center">
                                        <div id="sourceLinkContainer" style="display: none;" class="mb-3">
                                            <a id="sourceLink" href="#" target="_blank"
                                                class="btn btn-sm btn-outline-info" style="border-radius: 20px;">
                                                <i class="fas fa-external-link-alt mr-1"></i> View on Panoramax
                                            </a>
                                        </div>
                                        <button id="reopenBtn" class="btn btn-primary btn-block py-3 mb-3"
                                            style="border-radius: 30px; font-weight: 600;">
                                            <i class="fas fa-external-link-alt mr-2"></i> Re-open 3D Preview
                                        </button>
                                        <button class="btn btn-outline-secondary btn-block"
                                            onclick="location.reload()">Start New Analysis</button>
                                    </div>

                                    <!-- Analysis Breakdown Table -->
                                    <div class="mt-4 p-3 bg-white border rounded shadow-sm">
                                        <h6 class="font-weight-bold text-dark border-bottom pb-2 mb-3">ANALYSIS
                                            BREAKDOWN</h6>
                                        <table class="table table-sm table-borderless small m-0">
                                            <thead>
                                                <tr class="text-muted" style="font-size: 0.7rem;">
                                                    <th>STAGE</th>
                                                    <th class="text-center">FOV</th>
                                                    <th class="text-center">ROLL</th>
                                                    <th class="text-center">PITCH</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>Pass 1 (Crude)</td>
                                                    <td class="text-center" id="p1-fov">120°</td>
                                                    <td class="text-center font-weight-bold" id="p1-roll">0.00°</td>
                                                    <td class="text-center font-weight-bold" id="p1-pitch">0.00°</td>
                                                </tr>
                                                <tr>
                                                    <td>Pass 2 (Refined)</td>
                                                    <td class="text-center" id="p2-fov">60°/60°</td>
                                                    <td class="text-center font-weight-bold" id="p2-roll">0.00°</td>
                                                    <td class="text-center font-weight-bold" id="p2-pitch">0.00°</td>
                                                </tr>
                                                <tr class="border-top">
                                                    <td class="font-weight-bold">Final Correct.</td>
                                                    <td class="text-center">-</td>
                                                    <td class="text-center font-weight-bold text-danger"
                                                        id="final-roll-t">0.00°</td>
                                                    <td class="text-center font-weight-bold text-warning"
                                                        id="final-pitch-t">0.00°</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Cubemap Faces -->
                                <div class="col-lg-7">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <div class="btn-group btn-group-sm mr-3" role="group">
                                            <button type="button" id="btn-pass1"
                                                class="btn btn-outline-secondary active" onclick="switchPass(1)">PASS 1
                                                (CRUDE)</button>
                                            <button type="button" id="btn-pass2" class="btn btn-outline-secondary"
                                                onclick="switchPass(2)">PASS 2 (REFINED)</button>
                                        </div>
                                        <div class="custom-control custom-switch">
                                            <input type="checkbox" class="custom-control-input"
                                                id="toggleFaceCorrection">
                                            <label class="custom-control-label font-weight-bold"
                                                for="toggleFaceCorrection">SHOW CORRECTED</label>
                                        </div>
                                    </div>

                                    <div class="row no-gutters text-center">
                                        <div class="col-3 p-1">
                                            <div class="face-container bg-dark rounded overflow-hidden shadow-sm"
                                                style="position: relative; aspect-ratio: 1/1;">
                                                <img id="img-F" class="face-img" src=""
                                                    style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);">
                                                <div class="face-label"
                                                    style="position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.6); color: white; font-size: 0.6rem; font-weight: bold; padding: 2px 0;">
                                                    FRONT</div>
                                            </div>
                                            <div class="small mt-1 font-weight-bold" id="val-F">0.00°</div>
                                        </div>
                                        <div class="col-3 p-1">
                                            <div class="face-container bg-dark rounded overflow-hidden shadow-sm"
                                                style="position: relative; aspect-ratio: 1/1;">
                                                <img id="img-R" class="face-img" src=""
                                                    style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);">
                                                <div class="face-label"
                                                    style="position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.6); color: white; font-size: 0.6rem; font-weight: bold; padding: 2px 0;">
                                                    RIGHT</div>
                                            </div>
                                            <div class="small mt-1 font-weight-bold" id="val-R">0.00°</div>
                                        </div>
                                        <div class="col-3 p-1">
                                            <div class="face-container bg-dark rounded overflow-hidden shadow-sm"
                                                style="position: relative; aspect-ratio: 1/1;">
                                                <img id="img-B" class="face-img" src=""
                                                    style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);">
                                                <div class="face-label"
                                                    style="position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.6); color: white; font-size: 0.6rem; font-weight: bold; padding: 2px 0;">
                                                    BACK</div>
                                            </div>
                                            <div class="small mt-1 font-weight-bold" id="val-B">0.00°</div>
                                        </div>
                                        <div class="col-3 p-1">
                                            <div class="face-container bg-dark rounded overflow-hidden shadow-sm"
                                                style="position: relative; aspect-ratio: 1/1;">
                                                <img id="img-L" class="face-img" src=""
                                                    style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);">
                                                <div class="face-label"
                                                    style="position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.6); color: white; font-size: 0.6rem; font-weight: bold; padding: 2px 0;">
                                                    LEFT</div>
                                            </div>
                                            <div class="small mt-1 font-weight-bold" id="val-L">0.00°</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="error" class="alert alert-danger mt-4" style="display: none; border-radius: 10px;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

    <script>
        let lastResult = null;
        let currentPass = 1;

        // Load saved FOV values on page load
        document.addEventListener('DOMContentLoaded', () => {
            const savedFov1 = localStorage.getItem('fov_pass1');
            const savedFov2fb = localStorage.getItem('fov_pass2_fb');
            const savedFov2lr = localStorage.getItem('fov_pass2_lr');

            if (savedFov1) document.getElementById('fov_pass1').value = savedFov1;
            if (savedFov2fb) document.getElementById('fov_pass2_fb').value = savedFov2fb;
            if (savedFov2lr) document.getElementById('fov_pass2_lr').value = savedFov2lr;
        });

        // Save FOV values when they change
        document.getElementById('fov_pass1').addEventListener('change', (e) => {
            localStorage.setItem('fov_pass1', e.target.value);
        });
        document.getElementById('fov_pass2_fb').addEventListener('change', (e) => {
            localStorage.setItem('fov_pass2_fb', e.target.value);
        });
        document.getElementById('fov_pass2_lr').addEventListener('change', (e) => {
            localStorage.setItem('fov_pass2_lr', e.target.value);
        });

        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const form = e.target;
            const formData = new FormData(form);
            const submitBtn = document.getElementById('submitBtn');
            const loading = document.getElementById('loading');
            const setupSection = document.getElementById('setup-section');
            const results = document.getElementById('results');
            const error = document.getElementById('error');

            // Reset UI
            submitBtn.disabled = true;
            const randomBtn = document.getElementById('randomBtn');
            if (randomBtn) randomBtn.disabled = true;

            loading.style.display = 'block';
            error.style.display = 'none';

            try {
                const response = await fetch('/api/predict_360', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.status === 'success') {
                    lastResult = data;

                    // Check if current URL is a Panoramax HD image
                    const urlVal = document.getElementById('url').value;
                    let panoramaxId = null;
                    if (urlVal.includes('api.panoramax.xyz/api/pictures/')) {
                        const match = urlVal.match(/pictures\/(.+)\/hd\.jpg/);
                        if (match) panoramaxId = match[1];
                    }

                    renderResults(panoramaxId);
                    setupSection.style.display = 'none';
                    results.style.display = 'block';
                    openPreviewTab(data);
                } else {
                    error.textContent = data.error || 'An error occurred during processing.';
                    error.style.display = 'block';
                    submitBtn.disabled = false;
                    if (randomBtn) randomBtn.disabled = false;
                    loading.style.display = 'none';
                }
            } catch (err) {
                console.error(err);
                error.textContent = 'Failed to connect to the server or process the image.';
                error.style.display = 'block';
                submitBtn.disabled = false;
                if (randomBtn) randomBtn.disabled = false;
                loading.style.display = 'none';
            }
        });

        function renderResults(panoramaxId = null) {
            if (!lastResult) return;

            document.getElementById('rollVal').textContent = lastResult.roll.toFixed(2) + '°';
            document.getElementById('pitchVal').textContent = lastResult.pitch.toFixed(2) + '°';

            // Source Link
            const sourceContainer = document.getElementById('sourceLinkContainer');
            if (panoramaxId) {
                const sourceLink = document.getElementById('sourceLink');
                sourceLink.href = `https://api.panoramax.xyz/#focus=pic&pic=${panoramaxId}`;
                sourceContainer.style.display = 'block';
            } else {
                sourceContainer.style.display = 'none';
            }

            // Update Breakdown Table
            document.getElementById('p1-fov').textContent = lastResult.fov.pass1.toFixed(0) + '°';
            document.getElementById('p1-roll').textContent = lastResult.pass1.roll.toFixed(2) + '°';
            document.getElementById('p1-pitch').textContent = lastResult.pass1.pitch.toFixed(2) + '°';
            document.getElementById('p2-fov').textContent = `${lastResult.fov.pass2_fb.toFixed(0)}°/${lastResult.fov.pass2_lr.toFixed(0)}°`;
            document.getElementById('p2-roll').textContent = lastResult.pass2_residual.roll.toFixed(2) + '°';
            document.getElementById('p2-pitch').textContent = lastResult.pass2_residual.pitch.toFixed(2) + '°';
            document.getElementById('final-roll-t').textContent = lastResult.roll.toFixed(2) + '°';
            document.getElementById('final-pitch-t').textContent = lastResult.pitch.toFixed(2) + '°';

            switchPass(1);
        }

        function switchPass(passNumber) {
            currentPass = passNumber;
            if (!lastResult) return;

            document.getElementById('btn-pass1').classList.toggle('active', passNumber === 1);
            document.getElementById('btn-pass2').classList.toggle('active', passNumber === 2);

            const passData = passNumber === 1 ? lastResult.pass1 : lastResult.pass2_residual;
            const faces = ['F', 'R', 'B', 'L'];

            faces.forEach(face => {
                document.getElementById(`val-${face}`).textContent = passData.face_angles[face].toFixed(2) + '°';
                document.getElementById(`img-${face}`).src = `/mem_image/${passData.face_ids[face]}`;
            });

            // Reset correction toggle when switching passes
            document.getElementById('toggleFaceCorrection').checked = false;
            applyFaceRotations(false);
        }

        function applyFaceRotations(enabled) {
            if (!lastResult) return;
            const passData = currentPass === 1 ? lastResult.pass1 : lastResult.pass2_residual;
            const faces = ['F', 'R', 'B', 'L'];

            faces.forEach(face => {
                const img = document.getElementById(`img-${face}`);
                if (enabled) {
                    // Correct Rotation: Swapped sign based on user feedback
                    const angle = passData.face_angles[face];
                    img.style.transform = `rotate(${angle}deg)`;
                } else {
                    img.style.transform = 'rotate(0deg)';
                }
            });
        }

        document.getElementById('toggleFaceCorrection').addEventListener('change', function (e) {
            applyFaceRotations(e.target.checked);
        });

        function openPreviewTab(data) {
            const params = new URLSearchParams({
                img: `/mem_image/${data.main_id}`,
                pitch: data.pitch,
                roll: data.roll
            });
            window.open(`/viewer_360?${params.toString()}`, '_blank');
        }

        document.getElementById('reopenBtn').addEventListener('click', () => {
            if (lastResult) openPreviewTab(lastResult);
        });

        // Random Button Logic
        document.getElementById('randomBtn').addEventListener('click', async () => {
            const btn = document.getElementById('randomBtn');
            const urlInput = document.getElementById('url');
            const originalText = btn.innerHTML;

            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';

                const response = await fetch('/api/random_id');
                const data = await response.json();

                if (data.id) {
                    urlInput.value = `https://api.panoramax.xyz/api/pictures/${data.id}/hd.jpg`;
                    // Restore text immediately so if we come back it looks right
                    btn.innerHTML = originalText;
                    // Trigger form submission - this will keep the button disabled
                    document.getElementById('uploadForm').dispatchEvent(new Event('submit'));
                } else {
                    alert('Failed to get random image ID');
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            } catch (err) {
                console.error(err);
                alert('Error fetching random image');
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });
    </script>
</body>

</html>